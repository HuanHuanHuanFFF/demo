## **📌 请求执行链（Spring MVC 基础流程）**

```
浏览器 → DispatcherServlet → HandlerMapping → HandlerAdapter  
       → Controller → Service → Dao/Mapper → MySQL  
       ← 返回层层封装后响应给前端
```

最重要的：**所有请求都先到 DispatcherServlet，由它决定让哪个 Controller 来处理。**

---

## **📌 IoC（控制反转）**

* **概念**：对象（Bean）不是你自己 `new` 的，是 **Spring 在启动时统一创建** 并放进容器里。  
* **好处**：你只管写逻辑，不用关心对象生命周期、依赖管理。

关键点：  
✔ 启动时创建所有单例 Bean  
✔ Bean 之间依赖关系由 Spring 自动解析

---

## **📌 DI（依赖注入）**

* **概念**：需要用到某个 Bean 时，Spring 会自动塞给你，不用自己创建。  
* **方式**：构造器注入（推荐）、`@Autowired`、`@Resource`

---

## **📌 常用注解与区别（最重要的几个）**

### **1) Bean 类注解（注册到 IoC 容器）**

| 注解                | 作用                                        |
| ----------------- | ----------------------------------------- |
| `@RestController` | 等价于 `@Controller + @ResponseBody`，返回 JSON |
| `@Controller`     | MVC 控制器，一般返回页面                            |
| `@Service`        | 服务层 Bean，语义化标记                            |
| `@Repository`     | DAO 层 Bean，支持异常翻译                         |
| `@Component`      | 最通用的组件注册注解                                |

---

### **2) 注入注解：@Autowired vs @Resource**

| 注解           | 默认注入方式          | 注意事项                    |
| ------------ | --------------- | ----------------------- |
| `@Autowired` | 按类型注入（by type）  | 常用，一般不会出错               |
| `@Resource`  | 优先按名称 → 找不到再按类型 | 名称写错会注入错误 Bean，不推荐初学者使用 |

> 实战：**优先用构造器注入（等效 @Autowired）**，更稳定。

---

### **3) 常见参数/映射注解**

| 注解                             | 用途                   |
| ------------------------------ | -------------------- |
| `@GetMapping` / `@PostMapping` | 映射 HTTP 请求方法与路径      |
| `@RequestParam`                | 获取 URL 查询参数（?page=1） |
| `@PathVariable`                | 获取路径参数（/todos/{id}）  |
| `@RequestBody`                 | 接 JSON 请求体           |
| `@Validated` / `@Valid`        | 启用参数校验               |

---

### **4) 实战最常用：构造器注入（推荐写法）**

```java
@Service
public class TodoServiceImpl implements TodoService {
    private final TodoMapper todoMapper;
    public TodoServiceImpl(TodoMapper todoMapper) {
        this.todoMapper = todoMapper;
    }
}
```

优点：  
✔ 不用写 `@Autowired`  
✔ 更安全（不可变）  
✔ 更容易测试  
✔ 不会循环依赖

---

## **📌 MVC 三层职责划分（最小可用版）**

| 层            | 职责                        |
| ------------ | ------------------------- |
| Controller   | 参数接收、校验、返回 JSON           |
| Service      | 业务逻辑、组合多个 Dao 调用          |
| Dao / Mapper | 数据库访问（SQL / MyBatis-Plus） |

---

## **📌 常用返回结构**

多数项目统一返回格式：

```
code: 状态码  
msg: 描述信息  
data: 数据主体（对象 / 列表 / 分页）
```

示例：

```json
{
  "code": 200,
  "msg": "ok",
  "data": {...}
}
```

项目中对应 `Result<T>`，错误码枚举：`SUCCESS(200)`、`PARAM_ERROR(1001)`、`NOT_FOUND(1004)`、`UPDATE_CONFLICT(409)`、`SERVER_ERROR(500)`。

---

## **📌 Redis 缓存策略（Todo 模块新增）**

### **1) 单条缓存（byId）**
- Key：`todo:byId:{id}`  
- 命中直接返回 JSON；未命中查库并回填。  
- TTL：30 分钟 + 抖动 0~5 分钟（避免同秒雪崩）。

### **2) NULL 缓存（防穿透）**
- 查库为 null 时写入 `"NULL"`，TTL 60 秒，阻挡不存在 id 的高频请求。

### **3) 列表缓存（分页/排序/模糊）**
- Key：`todo:list:v{ver}:{page}-{size}-{sort}-{dir}-{title}`  
- TTL：3 分钟 + 抖动 0~2 分钟。

### **4) 版本号命名空间**
- 全局版本键：`todo:list:ver`。  
- 读列表时拼接当前版本；任意写成功后 `INCR todo:list:ver`，让旧列表缓存自然失效，无需 `keys` 扫描。

### **5) 写后一致性**
- 新增 / 更新 / 删除 → 删除对应 `todo:byId:{id}` → `INCR todo:list:ver`。  
- 更新依赖 `@Version` 乐观锁，影响行数 0 抛 `UPDATE_CONFLICT`。

### **6) 探针**
- `GET /redis/ping`：自增 `test:ping`，用于验证 Redis 连接。

---

## **📌 运行要点**

- 配置：`application.properties` 中 MySQL 默认 `jdbc:mysql://localhost:3306/demo`（`root/root`），Redis 默认 `localhost:6379`（密码按需开启）。  
- 表结构：`todo` 含 `id`(AUTO)、`title`(varchar≤50)、`created_time`(timestamp/datetime)、`version`(int)。  
- 启动：`mvnw.cmd spring-boot:run`（Win）或 `./mvnw spring-boot:run`（类 Unix），端口 8080。
